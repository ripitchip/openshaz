services:
  # ------------------------------------------------------
  # API & WORKERS (Custom Logic)
  # ------------------------------------------------------
  frontend:
    build: ../frontend
    ports:
      - "3001:80"
    environment:
      VITE_API_URL: http://localhost:8000
    networks:
      - internal
    depends_on:
      - api

  api:
    build: ./app/api
    ports:
      - "${FASTAPI_PORT}:${FASTAPI_PORT}"
    environment:
      ENV: dev
      FASTAPI_HOST: ${FASTAPI_HOST}
      FASTAPI_PORT: ${FASTAPI_PORT}
      RABBITMQ_URL: ${RABBITMQ_URL}
      OBJECT_STORAGE_URL: ${OBJECT_STORAGE_URL}
      OBJECT_STORAGE_ACCESS_KEY: ${OBJECT_STORAGE_ACCESS_KEY}
      OBJECT_STORAGE_SECRET_KEY: ${OBJECT_STORAGE_SECRET_KEY}
      OBJECT_STORAGE_REGION: ${OBJECT_STORAGE_REGION}
      EXTRACTION_BUCKET_NAME: ${EXTRACTION_BUCKET_NAME}
      SIMILARITY_BUCKET_NAME: ${SIMILARITY_BUCKET_NAME}
    depends_on:
      - rabbitmq
    networks:
      - internal

  worker:
    build: ./app/worker
    command: [
      "python",
      "src", 
      "worker", 
      # "--wipe-database", 
      # "--wipe-storage",
      "--debug"]
    deploy:
      replicas: 10
    environment:
      RABBITMQ_URL: ${RABBITMQ_URL}
      OBJECT_STORAGE_URL: ${OBJECT_STORAGE_URL}
      OBJECT_STORAGE_ACCESS_KEY: ${OBJECT_STORAGE_ACCESS_KEY}
      OBJECT_STORAGE_SECRET_KEY: ${OBJECT_STORAGE_SECRET_KEY}
      OBJECT_STORAGE_REGION: ${OBJECT_STORAGE_REGION}
      EXTRACTION_BUCKET_NAME: ${EXTRACTION_BUCKET_NAME}
      SIMILARITY_BUCKET_NAME: ${SIMILARITY_BUCKET_NAME}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_ADDRESS: ${POSTGRES_ADDRESS}
      POSTGRES_PORT: ${POSTGRES_PORT}
    depends_on:
      - rabbitmq
    networks:
      - internal
    volumes:
      - worker_logs:/worker_logs

  # ------------------------------------------------------
  # OBSERVABILITY (All-in-One)
  # ------------------------------------------------------
  lgtm:
    image: grafana/otel-lgtm:latest
    ports:
      - "3000:3000" # Grafana Web UI
      - "9090:9090" # Prometheus API
      - "3100:3100" # Loki API
    networks:
      - internal

  promtail:
    image: grafana/promtail:latest
    command: -config.file=/etc/promtail/promtail.yml
    volumes:
      # Your existing volume
      - worker_logs:/worker_logs:ro
      # Your preferred config path
      - ./promtail/promtail.yml:/etc/promtail/promtail.yml
      # NEW: Required for "read everything" mode
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    networks:
      - internal
    depends_on:
      - lgtm

  # ------------------------------------------------------
  # INFRASTRUCTURE (Storage & Messaging)
  # ------------------------------------------------------
  # rustfs:
  #   image: rustfs/rustfs:latest
  #   restart: unless-stopped
  #   volumes:
  #     - rustfs-data:/data
  #     - rustfs-logs:/app/logs
  #   environment:
  #     RUSTFS_VOLUMES: ${RUSTFS_VOLUMES}
  #     RUSTFS_ADDRESS: ${RUSTFS_ADDRESS}
  #     RUSTFS_CONSOLE_ADDRESS: ${RUSTFS_CONSOLE_ADDRESS}
  #     RUSTFS_CONSOLE_ENABLE: ${RUSTFS_CONSOLE_ENABLE}
  #     RUSTFS_ACCESS_KEY: ${RUSTFS_ACCESS_KEY}
  #     RUSTFS_SECRET_KEY: ${RUSTFS_SECRET_KEY}
  #     RUSTFS_CORS_ALLOWED_ORIGINS: ${RUSTFS_CORS_ALLOWED_ORIGINS}
  #     RUSTFS_CONSOLE_CORS_ALLOWED_ORIGINS: ${RUSTFS_CONSOLE_CORS_ALLOWED_ORIGINS}
  #   ports:
  #     - "9000:9000"
  #     - "9001:9001"
  #   healthcheck:
  #     test: ["CMD", "sh", "-c", "curl -f http://localhost:9000/health && curl -f http://localhost:9001/rustfs/console/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 40s
  #   deploy:
  #     resources:
  #       limits:
  #         cpus: "2.0"
  #         memory: 4GB
  #   networks:
  #     - internal

  # postgres:
  #   build: ./postgres 
  #   command:
  #     - "postgres"
  #     - "-c"
  #     - "log_min_duration_statement=0"
  #     - "-c"
  #     - "log_statement=none"
  #     - "-c"
  #     - "log_line_prefix=%m "
  #   environment:
  #     POSTGRES_USER: ${POSTGRES_USER}
  #     POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
  #     POSTGRES_DB: ${POSTGRES_DB}
  #   volumes:
  #     - pgdata:/var/lib/postgresql
  #   ports:
  #     - "5432:5432"
  #   networks:
  #     - internal

  rabbitmq:
    image: rabbitmq:3-management
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS}
      RABBITMQ_DEFAULT_VHOST: ${RABBITMQ_DEFAULT_VHOST}
      RABBITMQ_ERLANG_COOKIE: ${RABBITMQ_ERLANG_COOKIE}
    ports:
      - "5672:5672"     # AMQP protocol port
      - "15672:15672"   # RabbitMQ Management UI
      - "15692:15692"   # Prometheus exporter
    networks:
      - internal


  # postgres_exporter:
  #   image: prometheuscommunity/postgres-exporter
  #   environment:
  #     DATA_SOURCE_NAME: ${POSTGRES_EXPORTER_DATA_SOURCE_NAME}
  #   networks:
  #     - internal
  #   depends_on:
  #     - postgres

networks:
  internal:

volumes:
  pgdata:
  worker_logs:
  rustfs-data:
  rustfs-logs: